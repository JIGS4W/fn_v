<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Manager Dashboard - Cafe POS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Kanit', sans-serif; }
        .fade-in { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar - ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ò‡∏µ‡∏° */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d97706; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f5f5f4; }

        /* Loader */
        .loader-overlay {
            position: fixed; inset: 0; z-index: 9999;
            background: rgba(28, 25, 23, 0.9); /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á Dark */
            backdrop-filter: blur(4px);
            display: flex; justify-content: center; align-items: center;
        }
        .loader { width: 80px; height: 80px; position: relative; animation: shake 3s infinite ease-in-out; }
        .cup { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 40px; height: 30px; background-color: #d6d3d1; border-radius: 0 0 15px 15px; z-index: 1; animation: cupPulse 6s infinite ease-in-out; }
        .cup::after { content: ""; position: absolute; top: -5px; left: 0; width: 100%; height: 10px; background: #d97706; border-radius: 50%; }
        .cup-handle { position: absolute; top: 5px; right: -12px; width: 12px; height: 18px; border: 3px solid #d6d3d1; border-left: none; border-radius: 0 10px 10px 0; }
        .smoke { position: absolute; bottom: 100%; left: 50%; width: 6px; height: 15px; background: rgba(255, 255, 255, 0.3); border-radius: 50%; transform: translateX(-50%); animation: rise 2.5s infinite ease-in-out; }
        .smoke.one { animation-delay: 0s; } .smoke.two { animation-delay: 0.6s; }
        @keyframes rise { 0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; } 100% { transform: translate(-50%, -40px) scale(1.5); opacity: 0; } }
        @keyframes shake { 0%, 100% { transform: rotate(0); } 25% { transform: rotate(-3deg); } 75% { transform: rotate(3deg); } }

        .toast-enter-active, .toast-leave-active { transition: all 0.5s ease; }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateX(100%); }
        .toast-enter-to, .toast-leave-from { opacity: 1; transform: translateX(0); }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="bg-gradient-to-br from-[#1c1917] via-[#292524] to-[#451a03] text-stone-700 min-h-screen flex flex-col relative">
    
    <div class="fixed inset-0 z-0 opacity-5 pointer-events-none" style="background-image: radial-gradient(#ffffff 1px, transparent 1px); background-size: 32px 32px;"></div>

    <div id="app" class="min-h-screen flex flex-col relative z-10">
        <div v-if="isLoggingOut" class="loader-overlay">
            <div class="loader">
                <div class="cup"><div class="cup-handle"></div><div class="smoke one"></div><div class="smoke two"></div></div>
                <div class="absolute -bottom-8 w-full text-center text-xs font-bold text-stone-300">Log out...</div>
            </div>
        </div>
        
        <div v-if="showDeleteModal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" @click="showDeleteModal = false"></div>
            <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm relative z-10 text-center fade-in border border-stone-200">
                <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 text-2xl shadow-inner">
                    <i class="fa-solid fa-trash-can"></i>
                </div>
                <h3 class="text-xl font-bold text-stone-800 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?</h3>
                <p class="text-stone-500 text-sm mb-6">{{ deleteMessage }}</p>
                <div class="flex gap-3">
                    <button @click="showDeleteModal = false" class="flex-1 py-3 bg-stone-100 hover:bg-stone-200 text-stone-600 rounded-xl font-bold transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button @click="processDelete" class="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold shadow-lg shadow-red-200 transition">‡∏•‡∏ö‡πÄ‡∏•‡∏¢</button>
                </div>
            </div>
        </div>

        <nav class="bg-[#292524]/90 backdrop-blur-md border-b border-white/10 px-4 md:px-8 py-3 flex justify-between items-center z-40 sticky top-0 shadow-lg">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-br from-amber-600 to-amber-700 text-white w-10 h-10 rounded-xl flex items-center justify-center text-lg shadow-lg shadow-amber-900/50">
                    <i class="fa-solid fa-layer-group"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg md:text-xl text-stone-100 leading-none tracking-wide">Manager <span class="text-amber-500">Console</span></h1>
                    <p class="text-[10px] text-stone-400 font-medium uppercase tracking-wider">Cafe POS System</p>
                </div>
            </div>
            <button @click="logout" class="flex items-center gap-2 text-stone-400 hover:text-white hover:bg-red-500/80 px-4 py-2 rounded-full transition-all text-sm font-bold border border-white/5 hover:border-red-500/50">
                <span class="hidden md:inline">‡∏≠‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
                <i class="fa-solid fa-right-from-bracket"></i>
            </button>
        </nav>

        <div class="w-full max-w-[1600px] mx-auto p-4 md:p-6 pb-20">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
                
                <div class="order-1 lg:order-2 col-span-12 lg:col-span-4 lg:sticky lg:top-24 z-10 space-y-6">
                    
                    <div class="bg-white/95 backdrop-blur rounded-3xl shadow-xl border border-white/20 p-6">
                        <button @click="showHistoryStats = !showHistoryStats" class="w-full flex justify-between items-center group">
                            <h3 class="font-bold text-stone-700 text-lg flex items-center gap-3">
                                <span class="bg-stone-100 text-stone-500 w-8 h-8 rounded-lg flex items-center justify-center text-sm group-hover:bg-amber-500 group-hover:text-white transition-colors"><i class="fa-regular fa-calendar-days"></i></span>
                                ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢
                            </h3>
                            <span class="w-8 h-8 rounded-full border border-stone-200 flex items-center justify-center text-stone-400 group-hover:bg-stone-800 group-hover:text-white transition-all transform" :class="showHistoryStats ? 'rotate-180' : ''"><i class="fa-solid fa-chevron-down"></i></span>
                        </button>
                        <div v-if="showHistoryStats" class="mt-6 border-t border-stone-100 pt-4 fade-in">
                            <table class="w-full text-sm">
                                <thead class="text-stone-400 text-xs uppercase bg-stone-50">
                                    <tr>
                                        <th class="py-3 px-4 text-left rounded-l-xl">Date</th>
                                        <th class="py-3 px-4 text-right rounded-r-xl">Total</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-stone-100">
                                    <template v-for="day in dailySales" :key="day.sale_date">
                                        <tr @click="toggleDate(day.sale_date)" class="cursor-pointer hover:bg-amber-50 transition">
                                            <td class="py-3 px-4 font-bold text-stone-600">{{ formatDate(day.sale_date) }}</td>
                                            <td class="py-3 px-4 text-right font-black text-stone-800">{{ (Number(day.total)||0).toLocaleString() }}.-</td>
                                        </tr>
                                        <tr v-if="expandedDates.includes(day.sale_date)" class="bg-stone-50/80">
                                            <td colspan="2" class="p-4">
                                                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                                    <div v-for="(stat, catName) in getDayStats(day.sale_date)" :key="catName" class="text-xs bg-white p-2 rounded-lg border border-stone-100 flex flex-col items-center justify-center text-center shadow-sm">
                                                        <span class="text-stone-400 mb-1 truncate w-full">{{ catName }}</span>
                                                        <span class="font-bold text-stone-800">{{ stat.total.toLocaleString() }} ({{stat.count}})</span>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white/95 backdrop-blur rounded-3xl shadow-xl border border-white/20 overflow-hidden flex flex-col max-h-[85vh]">
                        <div class="p-4 border-b border-stone-100 bg-[#292524] text-white flex justify-between items-center flex-shrink-0">
                            <div class="flex items-center gap-2">
                                <h2 class="font-bold text-lg tracking-wide"><i class="fa-solid fa-bell mr-2 text-amber-500 animate-pulse"></i>Orders</h2>
                                <button @click="toggleAllOrders" class="text-[10px] bg-white/10 hover:bg-white/20 px-2 py-1 rounded transition">{{ allExpanded ? '‡∏¢‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : '‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' }}</button>
                            </div>
                            <span class="bg-gradient-to-r from-amber-500 to-orange-600 text-white text-sm font-bold px-3 py-1 rounded-full shadow-lg border border-white/10">{{ orders.length }}</span>
                        </div>
                        
                        <div class="overflow-y-auto p-3 bg-stone-100/50 space-y-2 flex-1 custom-scrollbar">
                            <div v-if="orders.length === 0" class="flex flex-col items-center justify-center py-10 text-stone-400">
                                <i class="fa-solid fa-mug-hot text-5xl mb-4 opacity-20"></i>
                                <p class="font-medium text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤</p>
                            </div>
                            <div v-for="o in orders" :key="o.id" class="bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden hover:shadow-md transition-shadow">
                                <div @click="o.expanded = !o.expanded" class="px-4 py-3 flex justify-between items-center cursor-pointer hover:bg-amber-50/30 select-none transition-colors">
                                    <div class="flex items-center gap-3">
                                        <div class="bg-stone-800 text-white text-xs font-bold px-2 py-1 rounded shadow-sm w-12 text-center">#{{ o.id }}</div>
                                        <div class="flex flex-col">
                                            <span class="text-xs text-stone-400 font-medium"><i class="fa-regular fa-clock mr-1"></i>{{ formatTime(o.created_at) }}</span>
                                            <span class="text-[10px] text-amber-600 font-medium" v-if="!o.expanded">{{ o.items.length }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="font-bold text-stone-800">{{ (Number(o.total) || 0).toLocaleString() }}.-</div>
                                        <i class="fa-solid fa-chevron-down text-xs text-stone-300 transition-transform duration-300" :class="o.expanded ? 'rotate-180' : ''"></i>
                                    </div>
                                </div>
                                <div v-if="o.expanded" class="px-4 pb-4 pt-0 border-t border-dashed border-stone-100 bg-stone-50/50">
                                    <div class="space-y-2 mt-3 mb-3">
                                        <div v-for="item in o.items" class="flex justify-between items-start text-sm">
                                            <div class="flex gap-2">
                                                <div class="font-bold text-stone-400 w-5 text-right">{{ item.qty || item.quantity || 1 }}x</div>
                                                <div>
                                                    <div class="font-bold text-stone-700">{{ item.name }}</div>
                                                    <div class="flex gap-1 flex-wrap mt-0.5">
                                                        <span v-if="item.sweetness" class="text-[10px] bg-amber-100 text-amber-700 px-1.5 rounded">‡∏´‡∏ß‡∏≤‡∏ô {{ item.sweetness }}</span>
                                                        <span v-if="item.spiciness" class="text-[10px] bg-red-100 text-red-700 px-1.5 rounded">{{ item.spiciness }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="text-stone-400 text-xs font-medium">{{ ((Number(item.price)||0) * (Number(item.qty || item.quantity)||1)).toLocaleString() }}</div>
                                        </div>
                                    </div>
                                    <div v-if="o.note" class="bg-yellow-50 border border-yellow-100 p-2 rounded-lg mb-3 flex gap-2 items-start">
                                        <i class="fa-regular fa-comment-dots text-yellow-500 mt-0 text-xs"></i>
                                        <span class="text-stone-700 text-xs font-medium">{{ o.note }}</span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button @click.stop="openDeleteModal('order', o.id, `‡∏à‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà #${o.id}?`)" class="py-2 rounded-lg border border-stone-200 text-stone-500 hover:bg-green-50 hover:text-green-600 hover:border-green-200 text-xs font-bold transition flex items-center justify-center gap-1">
                                            <i class="fa-solid fa-check"></i> ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
                                        </button>
                                        <button @click.stop="printReceipt(o)" class="py-2 rounded-lg bg-stone-800 text-white hover:bg-black text-xs font-bold transition flex items-center justify-center gap-1 shadow-md">
                                            <i class="fa-solid fa-print"></i> ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="order-2 lg:order-1 col-span-12 lg:col-span-8 space-y-6">
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gradient-to-br from-amber-600 via-orange-600 to-amber-700 text-white p-6 rounded-3xl shadow-xl shadow-amber-900/20 relative overflow-hidden group hover:scale-[1.02] transition-transform duration-300">
                            <div class="absolute right-0 top-0 opacity-20 text-9xl -mr-6 -mt-6 group-hover:rotate-12 transition-transform"><i class="fa-solid fa-wallet"></i></div>
                            <div class="relative z-10">
                                <p class="text-amber-100 text-xs font-medium mb-1 uppercase tracking-widest">Today's Sales</p>
                                <h2 class="text-4xl font-bold tracking-tight mb-2 drop-shadow-sm">{{ (Number(todayTotal) || 0).toLocaleString() }} <span class="text-sm font-normal text-amber-200">THB</span></h2>
                                <div class="flex items-center gap-2 text-xs text-amber-100/80 font-medium">
                                    <i class="fa-solid fa-receipt"></i> {{ todayOrdersCount }} Orders Completed
                                </div>
                            </div>
                        </div>

                        <div class="bg-white/95 backdrop-blur p-6 rounded-3xl shadow-xl border border-white/20 flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <p class="text-stone-400 text-xs font-bold uppercase">Categories</p>
                                <span class="bg-stone-100 text-stone-500 text-[10px] px-2 py-0.5 rounded-full font-bold">{{ categories.length }}</span>
                            </div>
                            <div class="flex flex-wrap gap-2 max-h-[150px] overflow-y-auto pr-2 custom-scrollbar">
                                <div v-for="c in categories" :key="c.id" class="flex items-center gap-1 bg-white border border-stone-200 px-3 py-1.5 rounded-lg text-xs font-bold text-stone-600 shadow-sm group hover:border-amber-400 hover:text-amber-700 transition-all">
                                    <span>{{ c.name }}</span>
                                    <div class="h-3 w-[1px] bg-stone-200 mx-1"></div>
                                    <button @click.stop="openDeleteModal('category', c.id, `‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà '${c.name}'?`)" class="text-stone-300 hover:text-red-500 p-0.5 rounded transition-colors"><i class="fa-solid fa-trash-can"></i></button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white/95 backdrop-blur p-6 rounded-3xl shadow-xl border border-white/20 flex flex-col justify-center relative overflow-hidden">
                            <div class="absolute right-0 bottom-0 opacity-5 text-8xl -mr-4 -mb-4 text-green-500"><i class="fa-solid fa-arrow-trend-up"></i></div>
                            <div class="relative z-10">
                                <div class="flex justify-between items-center mb-2">
                                    <p class="text-stone-400 text-xs font-bold uppercase">Best Selling Day</p>
                                </div>
                                <h3 class="text-2xl font-bold text-stone-800">{{ historyStats.max.toLocaleString() }}</h3>
                                <div class="text-xs text-green-600 mt-1 font-medium bg-green-50 inline-block px-2 py-1 rounded-lg">
                                    Avg: {{ historyStats.avg.toLocaleString() }} / day
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white/95 backdrop-blur rounded-3xl shadow-xl border border-white/20 overflow-hidden">
                        <div class="p-6 border-b border-stone-100 flex justify-between items-center flex-wrap gap-4 bg-stone-50/50">
                            <h3 class="font-bold text-xl text-stone-700 flex items-center gap-2">
                                <span class="bg-amber-100 text-amber-600 w-9 h-9 rounded-xl flex items-center justify-center text-sm shadow-sm"><i class="fa-solid fa-utensils"></i></span>
                                ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π
                            </h3>
                            <div class="flex gap-2 w-full md:w-auto">
                                <input id="catInput" v-model="newCatName" placeholder="‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà..." class="flex-1 bg-white border border-stone-200 text-sm px-4 py-2 rounded-xl focus:outline-none focus:border-amber-500 focus:ring-2 focus:ring-amber-100 w-full md:w-48 transition-all shadow-sm">
                                <button @click="addCategory" class="bg-stone-800 hover:bg-stone-900 text-white px-4 py-2 rounded-xl text-sm font-bold transition shadow-lg flex items-center gap-2">
                                    <i class="fa-solid fa-plus"></i> <span class="hidden sm:inline">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div class="bg-stone-50 rounded-2xl p-6 border border-stone-200 mb-8 relative group hover:border-amber-200 transition-colors shadow-inner">
                                <div class="absolute -top-3 left-6 bg-gradient-to-r from-stone-700 to-stone-800 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-lg border border-stone-600">ADD NEW ITEM</div>
                                <div class="grid grid-cols-1 md:grid-cols-12 gap-5 mt-2">
                                    <div class="md:col-span-12">
                                        <label class="block text-xs font-bold text-stone-500 mb-1.5 ml-1">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û / ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô</label>
                                        <div class="flex gap-3">
                                            <div class="w-12 h-12 rounded-xl bg-white border border-stone-200 flex items-center justify-center text-2xl shrink-0 shadow-sm text-stone-700">
                                                <img v-if="newP.icon && newP.icon.startsWith('http')" :src="newP.icon" class="w-full h-full object-cover rounded-xl">
                                                <span v-else>{{ newP.icon || '' }}</span>
                                            </div>
                                            <input v-model="newP.icon" placeholder="‡πÄ‡∏ä‡πà‡∏ô https://... ‡∏´‡∏£‡∏∑‡∏≠ Emoji ‚òï" class="flex-1 bg-white border border-stone-200 rounded-xl px-4 text-sm focus:ring-2 focus:ring-amber-100 focus:border-amber-500 outline-none shadow-sm transition-all">
                                        </div>
                                    </div>
                                    <div class="md:col-span-5">
                                        <label class="block text-xs font-bold text-stone-500 mb-1.5 ml-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</label>
                                        <input v-model="newP.name" class="w-full bg-white border border-stone-200 rounded-xl px-4 py-3 text-sm font-medium focus:ring-2 focus:ring-amber-100 focus:border-amber-500 outline-none shadow-sm transition-all">
                                    </div>
                                    <div class="md:col-span-3">
                                        <label class="block text-xs font-bold text-stone-500 mb-1.5 ml-1">‡∏£‡∏≤‡∏Ñ‡∏≤</label>
                                        <input v-model.number="newP.price" type="number" class="w-full bg-white border border-stone-200 rounded-xl px-4 py-3 text-sm font-bold text-stone-800 focus:ring-2 focus:ring-amber-100 focus:border-amber-500 outline-none shadow-sm transition-all">
                                    </div>
                                    <div class="md:col-span-4">
                                        <label class="block text-xs font-bold text-stone-500 mb-1.5 ml-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                                        <select v-model.number="newP.category_id" class="w-full bg-white border border-stone-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-amber-100 focus:border-amber-500 outline-none appearance-none shadow-sm cursor-pointer transition-all">
                                            <option :value="null" disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î --</option>
                                            <option v-for="c in categories" :value="c.id">{{ c.name }}</option>
                                        </select>
                                    </div>
                                    <div class="md:col-span-8 flex flex-wrap gap-6 items-center pt-2">
                                        <label class="flex items-center cursor-pointer gap-3 select-none group">
                                            <div class="relative">
                                                <input type="checkbox" v-model="newP.has_sweetness" class="sr-only peer">
                                                <div class="w-10 h-6 bg-stone-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-500"></div>
                                            </div>
                                            <span class="text-sm font-medium text-stone-600 group-hover:text-stone-800">‡∏õ‡∏£‡∏±‡∏ö‡∏´‡∏ß‡∏≤‡∏ô‡πÑ‡∏î‡πâ</span>
                                        </label>
                                    </div>
                                    <div class="md:col-span-4 mt-2 md:mt-0">
                                        <button @click="addProduct" class="w-full bg-gradient-to-r from-amber-700 to-amber-600 hover:from-amber-800 hover:to-amber-700 text-white py-3 rounded-xl font-bold shadow-lg shadow-amber-600/20 transition-all transform active:scale-95 text-sm flex items-center justify-center gap-2">
                                            <i class="fa-solid fa-plus"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏ô‡∏π
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="w-full text-left border-collapse min-w-[500px]">
                                    <thead>
                                        <tr class="text-stone-400 text-xs uppercase tracking-wider border-b border-stone-100">
                                            <th class="pb-4 pl-4 font-medium">Product Info</th>
                                            <th class="pb-4 text-center font-medium">Category</th>
                                            <th class="pb-4 text-right font-medium">Price</th>
                                            <th class="pb-4 text-right font-medium pr-4">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-sm">
                                        <tr v-for="p in products" :key="p.id" class="group hover:bg-amber-50/30 transition-colors border-b border-stone-50 last:border-0">
                                            <td class="py-4 pl-4 flex items-center gap-4">
                                                <div class="w-12 h-12 rounded-xl bg-white flex items-center justify-center text-xl shrink-0 overflow-hidden border border-stone-200 shadow-sm text-stone-700">
                                                    <img v-if="p.icon && p.icon.startsWith('http')" :src="p.icon" class="w-full h-full object-cover">
                                                    <span v-else>{{ p.icon || '‚òï' }}</span>
                                                </div>
                                                <div>
                                                    <div class="font-bold text-stone-700 text-base group-hover:text-amber-800 transition-colors">{{ p.name }}</div>
                                                    <div class="flex gap-2 mt-1 opacity-70">
                                                        <span v-if="p.has_sweetness" class="bg-amber-100 text-amber-700 text-[10px] px-1.5 py-0.5 rounded font-bold">Sweetness</span>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="py-4 text-center">
                                                <span class="bg-white border border-stone-200 px-3 py-1 rounded-full text-xs text-stone-500 font-medium shadow-sm">{{ p.category_name }}</span>
                                            </td>
                                            <td class="py-4 text-right font-bold text-stone-800 text-base">{{ p.price }}</td>
                                            <td class="py-4 text-right pr-4">
                                                <button @click="openDeleteModal('product', p.id, `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π '${p.name}' ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)" class="text-stone-300 hover:text-red-500 w-10 h-10 rounded-xl hover:bg-red-50 transition flex items-center justify-center ml-auto">
                                                    <i class="fa-solid fa-trash-can"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue
        createApp({
            data() {
                return {
                    categories: [], products: [], orders: [], dailySales: [],
                    newP: { name: '', price: '', category_id: null, has_sweetness: false, icon: '' },
                    newCatName: '', isLoggingOut: false,
                    showDeleteModal: false, deleteTargetId: null, deleteType: null, deleteMessage: '',
                    token: localStorage.getItem('adminToken') || '',
                    showHistoryStats: false, expandedDates: [], allExpanded: false
                }
            },
            computed: {
                todayDate() { return new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Bangkok' }); },
                todayTotal() { 
                    return this.orders
                        .filter(o => this.isOrderToday(o.created_at))
                        .reduce((sum, o) => sum + (Number(o.total) || 0), 0);
                },
                todayOrdersCount() { 
                    return this.orders.filter(o => this.isOrderToday(o.created_at)).length; 
                },
                historyStats() {
                    if (!this.dailySales.length) return { total: 0, avg: 0, max: 0 };
                    const totals = this.dailySales.map(d => Number(d.total) || 0);
                    const sum = totals.reduce((a, b) => a + b, 0);
                    return { total: sum, avg: Math.round(sum / totals.length), max: Math.max(...totals) };
                }
            },
            methods: {
                async fetchAuth(url, options = {}) {
                    if (!this.token) { window.location.href = 'index.html'; return null; }
                    const headers = options.headers || {};
                    if (!(options.body instanceof FormData)) { headers['Content-Type'] = 'application/json'; }
                    headers['Authorization'] = `Bearer ${this.token}`;
                    try {
                        const res = await fetch(url, { ...options, headers });
                        if (res.status === 401) {
                            alert("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏"); localStorage.removeItem('adminToken'); window.location.href = 'index.html'; return null;
                        }
                        return res;
                    } catch (e) { console.error("Fetch Error:", e); return null; }
                },
                async loadData() {
                    try {
                        const [c, p, oData, s] = await Promise.all([ 
                            this.fetchAuth('/api/categories').then(r=>r?r.json():[]), 
                            this.fetchAuth('/api/products').then(r=>r?r.json():[]), 
                            this.fetchAuth('/api/orders').then(r=>r?r.json():[]), 
                            this.fetchAuth('/api/daily-sales').then(r=>r?r.json():[]) 
                        ]);
                        
                        if(c) this.categories = c; 
                        if(p) this.products = p; 
                        
                        if(oData) {
                            const oldExpanded = new Set(this.orders.filter(o => o.expanded).map(o => o.id));
                            this.orders = oData.map(o => ({ ...o, expanded: oldExpanded.has(o.id) }));
                        }
                        if(s) {
                            this.dailySales = s;
                            const currentTotal = this.todayTotal; 
                            const currentCount = this.todayOrdersCount;
                            const existingTodayIndex = this.dailySales.findIndex(d => d.sale_date === this.todayDate);
                            
                            if (existingTodayIndex !== -1) {
                                this.dailySales[existingTodayIndex].total = currentTotal;
                                this.dailySales[existingTodayIndex].count = currentCount;
                            } else if (currentTotal > 0 || currentCount > 0) {
                                this.dailySales.unshift({
                                    sale_date: this.todayDate,
                                    total: currentTotal,
                                    count: currentCount
                                });
                            }
                        }
                    } catch (e) { console.error("Load Error:", e); }
                },
                isOrderToday(dateStr) {
                    if (!dateStr) return false;
                    const orderDateVal = new Date(dateStr).toLocaleDateString('en-CA', { timeZone: 'Asia/Bangkok' });
                    return orderDateVal === this.todayDate;
                },
                formatDate(d) { if(!d) return '-'; const [y,m,da] = d.split('-'); return `${da}/${m}/${y}`; },
                formatTime(d) { 
                    if (!d) return ''; const dateString = typeof d === 'string' && !d.endsWith('Z') ? d + 'Z' : d;
                    return new Date(dateString).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Bangkok' }); 
                },
                isOrderToday(d) {
                    if (!d) return false;
                    const dateStr = (typeof d === 'string' && !d.endsWith('Z')) ? d + 'Z' : d;
                    const orderDate = new Date(dateStr).toLocaleDateString('en-CA', { timeZone: 'Asia/Bangkok' });
                    return orderDate === this.todayDate;
                },
                toggleAllOrders() {
                    this.allExpanded = !this.allExpanded;
                    this.orders.forEach(o => o.expanded = this.allExpanded);
                },
                toggleDate(date) {
                    if (this.expandedDates.includes(date)) this.expandedDates = this.expandedDates.filter(d => d !== date);
                    else this.expandedDates.push(date);
                },
                getDayStats(dateStr) {
                    const stats = {};
                    const dayOrders = this.orders.filter(o => o.created_at && o.created_at.startsWith(dateStr));
                    dayOrders.forEach(o => {
                        if(o.items && Array.isArray(o.items)) {
                            o.items.forEach(item => {
                                const product = this.products.find(p => p.name === item.name);
                                const categoryName = product ? product.category_name : '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
                                const qty = Number(item.qty || item.quantity || 1);
                                const total = (Number(item.price)||0) * qty;
                                if (!stats[categoryName]) stats[categoryName] = { count: 0, total: 0 };
                                stats[categoryName].count += qty; stats[categoryName].total += total;
                            });
                        }
                    });
                    return stats;
                },
                async addCategory() { 
                    if (!this.newCatName.trim()) return; 
                    await this.fetchAuth('/api/categories', { method: 'POST', body: JSON.stringify({ name: this.newCatName }) }); 
                    this.newCatName = ''; this.loadData(); 
                },
                async addProduct() {
                    if (!this.newP.name || !this.newP.price || !this.newP.category_id) {
                        alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏ä‡∏∑‡πà‡∏≠, ‡∏£‡∏≤‡∏Ñ‡∏≤ ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
                        return;
                    }
                    const payload = {
                        name: this.newP.name.toString().trim(),
                        price: Number(this.newP.price),
                        category_id: Number(this.newP.category_id),
                        has_sweetness: this.newP.has_sweetness ? 1 : 0,
                        icon: this.newP.icon ? this.newP.icon.toString().trim() : '‚òï'
                    };
                    console.log("üì§ Sending:", payload);
                    try {
                        const res = await this.fetchAuth('/api/products', { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload) 
                        });

                        const textRes = await res.text();
                        if (!res.ok) {
                            console.error("Server Error:", textRes);
                            alert(`‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Server ‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤:\n${textRes}`);
                            return;
                        }

                        this.newP = { name: '', price: '', category_id: this.newP.category_id, has_sweetness: false, icon: '' };
                        this.loadData();
                        alert("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");

                    } catch (e) {
                        console.error("Network Error:", e);
                        alert("‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
                    }
                },
                openDeleteModal(type, id, message) {
                    this.deleteType = type; this.deleteTargetId = id; this.deleteMessage = message; this.showDeleteModal = true;
                },
                async processDelete() {
                    let url = '';
                    if (this.deleteType === 'product') url = `/api/products/${this.deleteTargetId}`;
                    else if (this.deleteType === 'category') url = `/api/categories/${this.deleteTargetId}`;
                    else if (this.deleteType === 'order') url = `/api/orders/${this.deleteTargetId}`;
                    
                    if (url) { 
                        const res = await this.fetchAuth(url, { method: 'DELETE' }); 
                        if(res.ok) this.loadData();
                        else alert("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠ Database Error)");
                    }
                    this.showDeleteModal = false;
                },
                printReceipt(order) {
                    const printWindow = window.open('', '_blank', 'width=400,height=600');
                    let itemsHtml = '';
                    if (order.items && Array.isArray(order.items)) {
                        order.items.forEach(item => {
                            const qty = Number(item.qty || item.quantity || 1);
                            const price = Number(item.price) || 0;
                            const subtotal = qty * price;
                            const sweetText = item.sweetness ? `<div style="font-size:10px; color:#666;">- ‡∏´‡∏ß‡∏≤‡∏ô ${item.sweetness}</div>` : '';
                            const spicyText = item.spiciness ? `<div style="font-size:10px; color:#666;">- ${item.spiciness}</div>` : '';
                            itemsHtml += `
                                <tr style="vertical-align: top;">
                                    <td style="padding-bottom: 8px;">${qty}</td>
                                    <td style="padding-bottom: 8px; padding-right:5px;"><div style="font-weight:bold;">${item.name}</div>${sweetText} ${spicyText}</td>
                                    <td style="text-align: right; padding-bottom: 8px; white-space: nowrap;">${subtotal.toLocaleString()}</td>
                                </tr>`;
                        });
                    }
                    const customerNote = order.note ? order.note : '-';
                    const receiptHtml = `
                        <!DOCTYPE html><html><head><title>Receipt #${order.id}</title>
                        <style>
                            @page { size: auto; margin: 0mm; }
                            body { font-family: 'Courier New', monospace; font-size: 12px; margin: 0; padding: 10px; display: flex; justify-content: center; background-color: white;}
                            .container { width: 100%; max-width: 74mm; }
                            .text-center { text-align: center; } .text-right { text-align: right; } .bold { font-weight: bold; }
                            table { width: 100%; border-collapse: collapse; }
                            th { text-align: left; font-size: 10px; border-bottom: 1px dashed #000; padding-bottom: 5px; margin-bottom: 5px; }
                            .divider { border-top: 1px dashed #000; margin: 10px 0; }
                            .note-box { border: 2px solid #000; padding: 8px; margin: 10px 0; text-align: center; border-radius: 4px; }
                            .btn-print { display: block; width: 100%; padding: 12px; margin-top: 15px; background: #000; color: white; border: none; cursor: pointer; }
                            @media print { .no-print { display: none; } }
                        </style></head>
                        <body>
                            <div class="container">
                                <div class="text-center bold" style="font-size: 16px; margin-bottom:5px;">CAFE POS</div>
                                <div class="text-center" style="font-size: 10px; margin-bottom: 10px;">${new Date().toLocaleDateString('th-TH')} ${new Date().toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'})}</div>
                                <div class="text-center bold" style="border-bottom: 1px solid #000; padding-bottom: 5px; margin-bottom: 10px;">QUEUE: #${order.id}</div>
                                <table><thead><tr><th style="width:15%">Q</th><th>Item</th><th style="text-align:right">Pr</th></tr></thead><tbody>${itemsHtml}</tbody></table>
                                <div class="note-box"><div style="font-size:10px; text-transform:uppercase;">Name</div><div style="font-size:14px; font-weight:800;">${customerNote}</div></div>
                                <div class="divider"></div>
                                <table><tr><td class="bold">Total</td><td class="text-right bold" style="font-size:16px">${(Number(order.total) || 0).toLocaleString()}.-</td></tr></table>
                                <div class="text-center" style="margin-top:15px; font-size:10px;">Thank You</div>
                                <button onclick="window.print()" class="btn-print no-print">PRINT RECEIPT</button>
                            </div>
                        </body></html>`;
                    printWindow.document.write(receiptHtml);
                    printWindow.document.close();
                },
                logout() { 
                    this.isLoggingOut = true; localStorage.removeItem('adminToken');
                    setTimeout(() => window.location.href = 'index.html', 1500); 
                },
            },
            mounted() { 
                if(!this.token) { window.location.href = 'index.html'; } 
                else { this.loadData(); setInterval(this.loadData, 3000); }
            }
        }).mount('#app')
    </script>
</body>
</html>